name: Terraform E2E Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format (auto-fix)
        run: terraform fmt -recursive

      - name: Commit & Push if changed
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ci: terraform auto-format"
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "Nothing to commit."
          fi

      - name: Install Kind & Kubectl
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          curl -LO "https://dl.k8s.io/release/v1.29.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Create Kind Cluster
        run: kind create cluster --wait 60s

      - name: Wait for Cluster DNS (CoreDNS)
        run: |
          kubectl rollout status deployment/coredns -n kube-system --timeout=90s

      # Prepare hostPath for PV BEFORE terraform apply!
      - name: Prepare hostPath for PV (Kind)
        run: |
          docker exec kind-control-plane mkdir -p /tmp/demo-data
          docker exec kind-control-plane chmod 777 /tmp/demo-data

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        env:
          TF_VAR_demo_password: testpassword123
        run: terraform plan -lock=false

      - name: Terraform Apply (Test)
        env:
          TF_VAR_demo_password: testpassword123
        run: terraform apply -auto-approve

      # ------------------- E2E/Smoke тесты -------------------

      - name: Wait for Demo Namespace
        run: |
          for i in {1..30}; do kubectl get ns demo && break || sleep 2; done

      - name: Wait for NGINX Pods
        run: |
          kubectl rollout status deployment/nginx-demo -n demo --timeout=120s

      - name: PVC Bound Test
        run: |
          kubectl get pvc demo-pvc -n demo -o jsonpath='{.status.phase}' | grep Bound

      - name: Check Service
        run: |
          kubectl get svc nginx-service -n demo

      - name: Port-Forward & cURL Test (NodePort)
        run: |
          kubectl port-forward svc/nginx-service 8080:80 -n demo &
          sleep 5
          curl -sf http://localhost:8080 | grep "K8s Demo via Terraform"

      # Для Ingress — установка ingress-nginx-контроллера, если нужно:
      - name: Install Ingress Controller (ingress-nginx)
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.1/deploy/static/provider/kind/deploy.yaml
          kubectl rollout status deployment/ingress-nginx-controller -n ingress-nginx --timeout=120s

      - name: Wait for Ingress Ready
        run: |
          kubectl wait --namespace ingress-nginx \
            --for=condition=Ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Ingress Test (localhost)
        run: |
          kubectl get ingress -n demo
          kubectl port-forward svc/ingress-nginx-controller -n ingress-nginx 8081:80 &
          sleep 10
          curl -sfH "Host: nginx-demo.local" http://localhost:8081/ | grep "K8s Demo via Terraform"

      - name: Check HPA Status
        run: |
          kubectl get hpa nginx-hpa -n demo

      # ---------------------------------------------------------

      - name: Terraform Destroy
        if: always()
        env:
          TF_VAR_demo_password: testpassword123
        run: terraform destroy -auto-approve

      - name: Delete Kind Cluster
        if: always()
        run: kind delete cluster
