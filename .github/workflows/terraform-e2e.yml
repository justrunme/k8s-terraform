# ‚úÖ GitHub Actions Workflow: Terraform E2E Test on Kind with PVC Fix
# –ü—Ä–æ–≤–µ—Ä–µ–Ω –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω: —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞, PVC, Ingress, Terraform, –ø–æ–ª–Ω–æ–µ E2E

name: Terraform E2E Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # üì• Checkout –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
      - name: Checkout code
        uses: actions/checkout@v4

      # üß∞ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ kind –∏ kubectl
      - name: Install Kind & Kubectl
        run: |
          curl -Lo kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
          chmod +x kind && sudo mv kind /usr/local/bin/
          curl -Lo kubectl https://dl.k8s.io/release/v1.29.0/bin/linux/amd64/kubectl
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/

      # üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kind
      - name: Create Kind Cluster
        run: kind create cluster --wait 90s

      # ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ CoreDNS (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
      - name: Wait for Cluster DNS (CoreDNS)
        run: |
          kubectl rollout status deployment/coredns -n kube-system --timeout=120s

      # üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ hostPath –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è PV
      - name: Prepare hostPath for PV
        run: |
          NODE=$(docker ps --filter name=control-plane --format '{{.Names}}')
          docker exec "$NODE" mkdir -p /tmp/demo-data
          docker exec "$NODE" chmod 777 /tmp/demo-data

      # üìÑ –Ø–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ PersistentVolume
      - name: Create demo-pv
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: demo-pv
          spec:
            capacity:
              storage: 1Gi
            accessModes:
              - ReadWriteOnce
            volumeMode: Filesystem
            persistentVolumeReclaimPolicy: Retain
            hostPath:
              path: /tmp/demo-data
          EOF

      # üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ‚öôÔ∏è Terraform init / validate / plan / apply
      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        env:
          TF_VAR_demo_password: ${{ secrets.DEMO_PASSWORD }}
        run: terraform plan -lock=false

      - name: Terraform Apply (Test)
        env:
          TF_VAR_demo_password: ${{ secrets.DEMO_PASSWORD }}
        run: terraform apply -auto-approve

      # üß™ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
      - name: Wait for Namespace demo
        run: for i in {1..30}; do kubectl get ns demo && break || sleep 5; done

      - name: Wait for nginx-demo deployment
        run: |
          kubectl rollout status deployment/nginx-demo -n demo --timeout=180s

      - name: Wait for PVC
        run: |
          for i in {1..15}; do
            kubectl get pvc demo-pvc -n demo && break || sleep 5
          done

      - name: Check PVC is Bound
        run: |
          for i in {1..15}; do
            phase=$(kubectl get pvc demo-pvc -n demo -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
            if [ "$phase" = "Bound" ]; then
              echo "‚úÖ PVC is Bound"
              exit 0
            else
              echo "PVC status: $phase. Waiting..."
              sleep 5
            fi
          done
          echo "‚ùå PVC did not reach Bound state in time!"
          exit 1

      # üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
      - name: Check Service
        run: kubectl get svc nginx-service -n demo

      # üîå Port-forward + cURL
      - name: Port-Forward & cURL Test (NodePort)
        run: |
          kubectl port-forward svc/nginx-service 30080:80 -n demo &
          sleep 5
          curl -sf http://localhost:30080 | grep "K8s Demo via Terraform"

      # üö™ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ingress-nginx
      - name: Install Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.1/deploy/static/provider/kind/deploy.yaml
          kubectl rollout status deployment/ingress-nginx-controller -n ingress-nginx --timeout=180s

      - name: Wait for Ingress Ready
        run: |
          kubectl wait --namespace ingress-nginx \
            --for=condition=Ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=180s

      - name: Ingress Test
        run: |
          kubectl get ingress -n demo
          kubectl port-forward svc/ingress-nginx-controller 8081:80 -n ingress-nginx &
          sleep 10
          curl -sfH "Host: nginx-demo.local" http://localhost:8081/ | grep "K8s Demo via Terraform"

      # üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ HPA (–µ—Å–ª–∏ –µ—Å—Ç—å)
      - name: Check HPA
        run: |
          kubectl get hpa nginx-hpa -n demo || echo "HPA not found"

      # üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
      - name: Terraform Destroy
        if: always()
        env:
          TF_VAR_demo_password: ${{ secrets.DEMO_PASSWORD }}
        run: |
          terraform init -backend=false
          terraform destroy -auto-approve

      - name: Delete Kind Cluster
        if: always()
        run: kind delete cluster
